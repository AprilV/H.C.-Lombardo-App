name: Update NFL 2025 Season Data

on:
  schedule:
    # Run every Monday at 2 AM UTC (after weekend games)
    - cron: '0 2 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4
        with:
          ref: refs/heads/master
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-dotenv psycopg2-binary nfl-data-py pandas numpy
      
      - name: Update 2025 season data
        env:
          DB_HOST: ${{ secrets.RENDER_DB_HOST }}
          DB_NAME: ${{ secrets.RENDER_DB_NAME }}
          DB_USER: ${{ secrets.RENDER_DB_USER }}
          DB_PASSWORD: ${{ secrets.RENDER_DB_PASSWORD }}
          DB_PORT: '5432'
        run: |
          python ingest_historical_games.py --production --seasons 2025
      
      - name: Verify update
        env:
          DB_HOST: ${{ secrets.RENDER_DB_HOST }}
          DB_NAME: ${{ secrets.RENDER_DB_NAME }}
          DB_USER: ${{ secrets.RENDER_DB_USER }}
          DB_PASSWORD: ${{ secrets.RENDER_DB_PASSWORD }}
          DB_PORT: '5432'
        run: |
          python -c "
          import psycopg2
          import os
          conn = psycopg2.connect(
              host=os.environ['DB_HOST'],
              database=os.environ['DB_NAME'],
              user=os.environ['DB_USER'],
              password=os.environ['DB_PASSWORD'],
              port=os.environ['DB_PORT']
          )
          cur = conn.cursor()
          cur.execute('SELECT COUNT(*), MAX(week) FROM hcl.games WHERE season = 2025 AND home_score IS NOT NULL')
          count, max_week = cur.fetchone()
          print(f'âœ… 2025 Season: {count} completed games through Week {max_week}')
          conn.close()
          "
