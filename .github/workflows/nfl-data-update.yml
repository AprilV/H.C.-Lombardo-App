name: NFL Data Update (PRODUCTION)

on:
  # Automatic schedule: Monday 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      seasons:
        description: 'Seasons to update'
        required: false
        default: '2025'

jobs:
  production-update:
    runs-on: ubuntu-latest
    name: Production NFL Database Update (hcl schema)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Verify SSM connectivity
        run: |
          echo "üîç Checking EC2 SSM registration..."
          aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --query "InstanceInformationList[0].PingStatus" \
            --output text
      
      - name: Pull latest code on EC2
        run: |
          echo "üì• Pulling latest code from GitHub..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --comment "PRODUCTION: Pull latest code" \
            --parameters 'commands=[
              "cd /home/ubuntu/H.C.-Lombardo-App && git pull origin master || echo Already up to date"
            ]' \
            --output text \
            --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          
          sleep 10
          
          STATUS=$(aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "Status" \
            --output text)
          
          echo "‚úÖ Git pull output:"
          aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "StandardOutputContent" \
            --output text
      
      - name: Load data to PRODUCTION schema (hcl)
        run: |
          SEASONS="${{ github.event.inputs.seasons || '2025' }}"
          echo "üöÄ PRODUCTION MODE - Loading to hcl schema"
          echo "Seasons: $SEASONS"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --comment "PRODUCTION: Load NFL data to hcl schema" \
            --timeout-seconds 600 \
            --parameters "commands=[
              \"cd /home/ubuntu/H.C.-Lombardo-App && . venv/bin/activate && python scripts/data_loading/ingest_historical_games.py --production --seasons $SEASONS\"
            ]" \
            --output text \
            --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for command to complete
          echo "‚è≥ Waiting for command to complete..."
          sleep 30
          
          # Check status
          STATUS=$(aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "Status" \
            --output text)
          
          echo "Status: $STATUS"
          
          echo "üìä Production data load output:"
          aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "StandardOutputContent" \
            --output text
          
          # Check if command succeeded
          if [ "$STATUS" != "Success" ]; then
            echo "‚ùå Command failed with status: $STATUS"
            echo "Error output:"
            aws ssm get-command-invocation \
              --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
              --command-id $COMMAND_ID \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi
          
          echo "‚úÖ Data loaded successfully to hcl (production) schema"
      
      - name: Verify PRODUCTION schema
        run: |
          echo "üîç Verifying hcl (production) schema was updated..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ubuntu/H.C.-Lombardo-App && . venv/bin/activate && python -c \"import psycopg2; from db_config import DATABASE_CONFIG; conn = psycopg2.connect(**DATABASE_CONFIG); cur = conn.cursor(); cur.execute(\\\"SELECT COUNT(*) FROM hcl.games WHERE season=2025\\\"); prod_count = cur.fetchone()[0]; cur.execute(\\\"SELECT COUNT(*) FROM hcl.team_game_stats WHERE season=2025\\\"); stats_count = cur.fetchone()[0]; print(f\\\"PRODUCTION schema: {prod_count} games, {stats_count} team stats (2025)\\\"); cur.close(); conn.close()\""
            ]' \
            --output text \
            --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          sleep 20
          
          STATUS=$(aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "Status" \
            --output text)
          
          echo "Status: $STATUS"
          
          echo "‚úÖ Verification results:"
          aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "StandardOutputContent" \
            --output text
          
          if [ "$STATUS" != "Success" ]; then
            echo "‚ùå Verification failed with status: $STATUS"
            echo "Error output:"
            aws ssm get-command-invocation \
              --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
              --command-id $COMMAND_ID \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi
      
      - name: Production workflow summary
        run: |
          echo "üéØ PRODUCTION WORKFLOW COMPLETE"
          echo "‚úÖ SSM connectivity verified"
          echo "‚úÖ Latest code pulled from GitHub"
          echo "‚úÖ Data loaded to hcl (production) schema"
          echo "‚úÖ Production database updated successfully"
          echo "üìÖ Next scheduled run: Monday 2 AM UTC"
