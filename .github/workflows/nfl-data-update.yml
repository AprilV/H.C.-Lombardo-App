name: NFL 2025 Data Update

on:
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          # Verify key file was created and has content
          if [ ! -s ~/.ssh/ec2_key.pem ]; then
            echo "‚ùå ERROR: SSH key file is empty or missing!"
            exit 1
          fi
          echo "‚úÖ SSH key file created ($(wc -l < ~/.ssh/ec2_key.pem) lines)"
          ssh-keyscan -H 34.198.25.249 >> ~/.ssh/known_hosts
          # Test SSH connection
          echo "üîç Testing SSH connection..."
          ssh -i ~/.ssh/ec2_key.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no -v ubuntu@34.198.25.249 'echo "SSH connection successful"' || {
            echo "‚ùå ERROR: SSH connection test failed!"
            exit 1
          }
      
      - name: Update 2025 NFL data on EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            ubuntu@34.198.25.249 \
            'cd /home/ubuntu/H.C.-Lombardo-App && source venv/bin/activate && python ingest_historical_games.py --production --seasons 2025' || {
              echo "‚ùå SSH command failed - workflow stopped"
              exit 1
            }
      
      - name: Verify update
        run: |
          ssh -i ~/.ssh/ec2_key.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            ubuntu@34.198.25.249 \
            'cd /home/ubuntu/H.C.-Lombardo-App && source venv/bin/activate && python -c "import psycopg2; conn = psycopg2.connect(host=\"localhost\", database=\"nfl_analytics\", user=\"nfl_user\", password=\"nfl2024\", port=5432); cur = conn.cursor(); cur.execute(\"SELECT COUNT(*), MAX(week) FROM hcl.games WHERE season = 2025 AND home_score IS NOT NULL\"); count, max_week = cur.fetchone(); print(f\"‚úÖ 2025 Season: {count} completed games through Week {max_week}\"); conn.close()"' || {
              echo "‚ùå Verification failed"
              exit 1
            }
