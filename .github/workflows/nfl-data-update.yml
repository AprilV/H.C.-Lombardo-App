name: NFL 2025 Data Update

on:
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H 34.198.25.249 >> ~/.ssh/known_hosts
      
      - name: Update 2025 NFL data on EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o ConnectTimeout=10 ubuntu@34.198.25.249 << 'EOF'
            cd ~/H.C.-Lombardo-App
            source venv/bin/activate
            python ingest_historical_games.py --production --seasons 2025
          EOF
      
      - name: Verify update
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o ConnectTimeout=10 ubuntu@34.198.25.249 << 'EOF'
            cd ~/H.C.-Lombardo-App
            source venv/bin/activate
            python -c "
import psycopg2
conn = psycopg2.connect(
    host='localhost',
    database='nfl_analytics',
    user='nfl_user',
    password='nfl2024',
    port=5432
)
cur = conn.cursor()
cur.execute('SELECT COUNT(*), MAX(week) FROM hcl.games WHERE season = 2025 AND home_score IS NOT NULL')
count, max_week = cur.fetchone()
print(f'âœ… 2025 Season: {count} completed games through Week {max_week}')
conn.close()
"
          EOF
