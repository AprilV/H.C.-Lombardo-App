name: NFL Data Update (TEST SCHEMA ONLY)

on:
  # Manual trigger only - no automatic schedule
  workflow_dispatch:
    inputs:
      seasons:
        description: 'Seasons to update'
        required: false
        default: '2025'

jobs:
  test-update:
    runs-on: ubuntu-latest
    name: Test NFL Database Update (hcl_test schema)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Verify SSM connectivity
        run: |
          echo "üîç Checking EC2 SSM registration..."
          aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --query "InstanceInformationList[0].PingStatus" \
            --output text
      
      - name: Pull latest code on EC2
        run: |
          echo "üì• Pulling latest code from GitHub..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --comment "TEST: Pull latest code" \
            --parameters 'commands=[
              "cd /home/ubuntu/H.C.-Lombardo-App",
              "git fetch origin",
              "git reset --hard origin/master",
              "git pull origin master"
            ]' \
            --output text \
            --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for command to complete
          aws ssm wait command-executed \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --max-attempts 60 \
            --delay 1
          
          echo "‚úÖ Git pull output:"
          aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "StandardOutputContent" \
            --output text
      
      - name: Load data to TEST schema (hcl_test)
        run: |
          SEASONS="${{ github.event.inputs.seasons || '2025' }}"
          echo "‚ö†Ô∏è TESTING MODE - Loading to hcl_test schema"
          echo "Seasons: $SEASONS"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --comment "TEST: Load NFL data to hcl_test schema" \
            --timeout-seconds 600 \
            --parameters "commands=[
              \"cd /home/ubuntu/H.C.-Lombardo-App\",
              \"source venv/bin/activate\",
              \"python ingest_historical_games.py --testbed --seasons $SEASONS\"
            ]" \
            --output text \
            --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for completion (max 10 minutes)
          aws ssm wait command-executed \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --max-attempts 120 \
            --delay 5
          
          echo "üìä Test data load output:"
          aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "StandardOutputContent" \
            --output text
      
      - name: Verify TEST schema (not production)
        run: |
          echo "üîç Verifying hcl_test schema was updated..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ubuntu/H.C.-Lombardo-App",
              "source venv/bin/activate",
              "python -c \"import psycopg2; conn = psycopg2.connect(dbname=\\\"nfl_analytics\\\", user=\\\"nfl_user\\\", password=\\\"nfl2024\\\", host=\\\"localhost\\\"); cur = conn.cursor(); cur.execute(\\\"SELECT COUNT(*) FROM hcl_test.games WHERE season=2025\\\"); test_count = cur.fetchone()[0]; cur.execute(\\\"SELECT COUNT(*) FROM hcl.games WHERE season=2025\\\"); prod_count = cur.fetchone()[0]; print(f\\\"TEST schema: {test_count} games (2025)\\\"); print(f\\\"PROD schema: {prod_count} games (2025)\\\"); print(f\\\"Production unchanged: YES\\\"); cur.close(); conn.close()\""
            ]' \
            --output text \
            --query "Command.CommandId")
          
          aws ssm wait command-executed \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID
          
          echo "‚úÖ Verification results:"
          aws ssm get-command-invocation \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --command-id $COMMAND_ID \
            --query "StandardOutputContent" \
            --output text
      
      - name: Test workflow summary
        run: |
          echo "üéØ TEST WORKFLOW COMPLETE"
          echo "‚úÖ SSM connectivity verified"
          echo "‚úÖ Latest code pulled from GitHub"
          echo "‚úÖ Data loaded to hcl_test schema"
          echo "‚úÖ Production schema UNTOUCHED"
          echo "‚úÖ Safe to proceed with production workflow"
